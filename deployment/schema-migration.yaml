steps:
- id: setup-install-cloud-sql-proxy
  name: gcr.io/cloud-builders/wget
  entrypoint: sh
  args:
    - -c
    - |
      wget -O /workspace/cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.19.0/cloud-sql-proxy.linux.amd64
      chmod +x /workspace/cloud-sql-proxy
    
- name: 'liquibase/liquibase:5.0'
  id: 'run-schema-migration'
  secretEnv: ["LIQUIBASE_COMMAND_USERNAME", "LIQUIBASE_COMMAND_PASSWORD", "INSTANCE_CONNECTION_NAME", "LIQUIBASE_COMMAND_DEFAULT_SCHEMA_NAME", "LIQUIBASE_LIQUIBASE_SCHEMA_NAME"]
  env:
    - 'CLOUD_SQL_PROXY_PORT=3306'
    - 'LIQUIBASE_COMMAND_URL=jdbc:mysql://127.0.0.1:3306/?useSSL=false&allowPublicKeyRetrieval=true'
  script: |
    cd /workspace/code

    # Start Cloud SQL Proxy
    /workspace/cloud-sql-proxy $INSTANCE_CONNECTION_NAME --port $CLOUD_SQL_PROXY_PORT & sleep 2

    # Execute sync script
    lpm add mysql --global
    liquibase --changeLogFile=src/main/changelogs/00-changelog-root.yaml status

availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/LIQUIBASE_USERNAME/versions/latest
      env: "LIQUIBASE_COMMAND_USERNAME"
    - versionName: projects/$PROJECT_ID/secrets/LIQUIBASE_PASSWORD/versions/latest
      env: "LIQUIBASE_COMMAND_PASSWORD"
    - versionName: projects/$PROJECT_ID/secrets/INSTANCE_CONNECTION_NAME/versions/latest
      env: "INSTANCE_CONNECTION_NAME"
    - versionName: projects/$PROJECT_ID/secrets/DEFAULT_SCHEMA/versions/latest
      env: "LIQUIBASE_COMMAND_DEFAULT_SCHEMA_NAME"
    - versionName: projects/$PROJECT_ID/secrets/LIQUIBASE_SCHEMA/versions/latest
      env: "LIQUIBASE_LIQUIBASE_SCHEMA_NAME"
options:
  logging: CLOUD_LOGGING_ONLY